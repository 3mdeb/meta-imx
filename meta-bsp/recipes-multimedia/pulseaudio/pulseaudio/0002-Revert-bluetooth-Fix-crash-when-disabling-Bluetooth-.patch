From 42debd7e749768a7ee76a1a3e3cb4be1a72b089f Mon Sep 17 00:00:00 2001
From: Shengjiu Wang <shengjiu.wang@nxp.com>
Date: Tue, 12 Jan 2021 14:28:24 +0800
Subject: [PATCH] Revert "bluetooth: Fix crash when disabling Bluetooth
 adapter"

This reverts commit f89d64b98e12bb71b6aa94fcef31eafc060f9759.
When make the bluetooth HFP call, will meet pulseaudio been auto killed issue
this is caused by this patch, revert this patch will fix the pulseaudio been
auto killed issue.

---
 src/modules/bluetooth/backend-ofono.c | 18 ------------------
 src/modules/bluetooth/bluez5-util.c   |  2 --
 src/modules/bluetooth/bluez5-util.h   |  1 -
 3 files changed, 21 deletions(-)

Index: pulseaudio-15.0/src/modules/bluetooth/backend-ofono.c
===================================================================
--- pulseaudio-15.0.orig/src/modules/bluetooth/backend-ofono.c
+++ pulseaudio-15.0/src/modules/bluetooth/backend-ofono.c
@@ -70,7 +70,6 @@ struct hf_audio_card {
     int (*acquire)(struct hf_audio_card *card);
 
     pa_bluetooth_transport *transport;
-    pa_hook_slot *device_unlink_slot;
 };
 
 struct pa_bluetooth_backend {
@@ -244,17 +243,6 @@ static int card_acquire(struct hf_audio_
     return -1;
 }
 
-static void hf_audio_agent_card_removed(pa_bluetooth_backend *backend, const char *path);
-
-static pa_hook_result_t device_unlink_cb(pa_bluetooth_discovery *y, const pa_bluetooth_device *d, struct hf_audio_card *card) {
-    pa_assert(d);
-    pa_assert(card);
-
-    hf_audio_agent_card_removed(card->backend, card->path);
-
-    return PA_HOOK_OK;
-}
-
 static struct hf_audio_card *hf_audio_card_new(pa_bluetooth_backend *backend, const char *path) {
     struct hf_audio_card *card = pa_xnew0(struct hf_audio_card, 1);
 
@@ -263,18 +251,12 @@ static struct hf_audio_card *hf_audio_ca
     card->fd = -1;
     card->acquire = card_acquire;
 
-    card->device_unlink_slot = pa_hook_connect(pa_bluetooth_discovery_hook(backend->discovery, PA_BLUETOOTH_HOOK_DEVICE_UNLINK),
-                                               PA_HOOK_NORMAL, (pa_hook_cb_t) device_unlink_cb, card);
-
     return card;
 }
 
 static void hf_audio_card_free(struct hf_audio_card *card) {
     pa_assert(card);
 
-    if (card->device_unlink_slot)
-        pa_hook_slot_free(card->device_unlink_slot);
-
     if (card->transport)
         pa_bluetooth_transport_free(card->transport);
 
Index: pulseaudio-15.0/src/modules/bluetooth/bluez5-util.c
===================================================================
--- pulseaudio-15.0.orig/src/modules/bluetooth/bluez5-util.c
+++ pulseaudio-15.0/src/modules/bluetooth/bluez5-util.c
@@ -1080,8 +1080,6 @@ static void device_free(pa_bluetooth_dev
 
     device_stop_waiting_for_profiles(d);
 
-    pa_hook_fire(&d->discovery->hooks[PA_BLUETOOTH_HOOK_DEVICE_UNLINK], d);
-
     for (i = 0; i < PA_BLUETOOTH_PROFILE_COUNT; i++) {
         pa_bluetooth_transport *t;
 
Index: pulseaudio-15.0/src/modules/bluetooth/bluez5-util.h
===================================================================
--- pulseaudio-15.0.orig/src/modules/bluetooth/bluez5-util.h
+++ pulseaudio-15.0/src/modules/bluetooth/bluez5-util.h
@@ -63,7 +63,6 @@ typedef struct pa_bluetooth_backend pa_b
 
 typedef enum pa_bluetooth_hook {
     PA_BLUETOOTH_HOOK_DEVICE_CONNECTION_CHANGED,        /* Call data: pa_bluetooth_device */
-    PA_BLUETOOTH_HOOK_DEVICE_UNLINK,                    /* Call data: pa_bluetooth_device */
     PA_BLUETOOTH_HOOK_TRANSPORT_STATE_CHANGED,          /* Call data: pa_bluetooth_transport */
     PA_BLUETOOTH_HOOK_TRANSPORT_SOURCE_VOLUME_CHANGED,  /* Call data: pa_bluetooth_transport */
     PA_BLUETOOTH_HOOK_TRANSPORT_SINK_VOLUME_CHANGED,    /* Call data: pa_bluetooth_transport */
