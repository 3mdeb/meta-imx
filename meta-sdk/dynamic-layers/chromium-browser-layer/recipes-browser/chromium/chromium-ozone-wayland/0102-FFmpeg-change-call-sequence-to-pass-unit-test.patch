From 0ca483c1a85cbc73db47462a9866a1a2f2c3a842 Mon Sep 17 00:00:00 2001
From: Qi Hou <nxf47649@lsv11151.swis.cn-sha01.nxp.com>
Date: Mon, 29 Nov 2021 14:47:02 +0800
Subject: [PATCH 2/4] FFmpeg: change call sequence to pass unit test

Upstream-Status: Inappropriate [NXP specific]
---
 libavcodec/v4l2_context.c | 75 +++++++++++++++++----------------------
 libavcodec/v4l2_m2m_dec.c | 18 +++++-----
 2 files changed, 40 insertions(+), 53 deletions(-)

Index: chromium-101.0.4951.54/third_party/ffmpeg/libavcodec/v4l2_context.c
===================================================================
--- chromium-101.0.4951.54.orig/third_party/ffmpeg/libavcodec/v4l2_context.c
+++ chromium-101.0.4951.54/third_party/ffmpeg/libavcodec/v4l2_context.c
@@ -560,6 +560,9 @@ int ff_v4l2_context_set_status(V4L2Conte
     int type = ctx->type;
     int ret;
 
+    if (ctx->streamon == (cmd == VIDIOC_STREAMON))
+        return 0;
+
     ret = ioctl(ctx_to_m2mctx(ctx)->fd, cmd, &type);
     if (ret < 0)
         return AVERROR(errno);
Index: chromium-101.0.4951.54/third_party/ffmpeg/libavcodec/v4l2_m2m_dec.c
===================================================================
--- chromium-101.0.4951.54.orig/third_party/ffmpeg/libavcodec/v4l2_m2m_dec.c
+++ chromium-101.0.4951.54/third_party/ffmpeg/libavcodec/v4l2_m2m_dec.c
@@ -153,6 +153,14 @@ static int v4l2_receive_frame(AVCodecCon
     if (s->draining)
         goto dequeue;
 
+    ret = v4l2_try_start(avctx);
+    if (ret) {
+        /* can't recover */
+        if (ret != AVERROR(ENOMEM))
+            ret = 0;
+        goto fail;
+    }
+
     ret = ff_v4l2_context_enqueue_packet(output, &s->buf_pkt);
     if (ret < 0 && ret != AVERROR(EAGAIN))
         goto fail;
@@ -161,16 +169,6 @@ static int v4l2_receive_frame(AVCodecCon
     if (ret != AVERROR(EAGAIN))
         av_packet_unref(&s->buf_pkt);
 
-    if (!s->draining) {
-        ret = v4l2_try_start(avctx);
-        if (ret) {
-            /* cant recover */
-            if (ret != AVERROR(ENOMEM))
-                ret = 0;
-            goto fail;
-        }
-    }
-
 dequeue:
     return ff_v4l2_context_dequeue_frame(capture, frame, -1);
 fail:
