From ba6857955cf66e467960cc9351df9f82f44f1423 Mon Sep 17 00:00:00 2001
From: Jerome Evillard <jerome.evillard@nxp.com>
Date: Tue, 29 Sep 2020 11:32:58 +0200
Subject: [PATCH] Support ARM compilation

---
 renderdoc/CMakeLists.txt                   | 7 ++++++-
 renderdoc/os/posix/linux/linux_process.cpp | 5 ++++-
 renderdoc/replay/replay_driver.cpp         | 4 ++--
 3 files changed, 12 insertions(+), 4 deletions(-)

diff --git a/renderdoc/CMakeLists.txt b/renderdoc/CMakeLists.txt
index 100e894..8c795c3 100644
--- a/renderdoc/CMakeLists.txt
+++ b/renderdoc/CMakeLists.txt
@@ -7,6 +7,11 @@ set(RDOC_INCLUDES
     PRIVATE ${RDOC_SOURCE_DIR}/3rdparty)
 set(RDOC_LIBRARIES)
 
+option(ARM "Arm architecture" ON)
+if(ARM)
+    set(RDOC_DEFINITIONS ${RDOC_DEFINITIONS} PRIVATE -D_ARM)
+endif()
+
 option(ENABLE_DLSYM_HOOKING "Enable dlsym() hooking via glibc internals" OFF)
 
 if(ENABLE_DLSYM_HOOKING)
@@ -333,7 +338,7 @@ elseif(UNIX)
         os/posix/posix_specific.h)
 endif()
 
-if(NOT ANDROID)
+if(NOT ANDROID AND NOT ARM)
     list(APPEND sources
         3rdparty/compressonator/BC1_Encode_kernel.cpp
         3rdparty/compressonator/BC2_Encode_kernel.cpp
diff --git a/renderdoc/os/posix/linux/linux_process.cpp b/renderdoc/os/posix/linux/linux_process.cpp
index 7db273f..9032009 100644
--- a/renderdoc/os/posix/linux/linux_process.cpp
+++ b/renderdoc/os/posix/linux/linux_process.cpp
@@ -198,11 +198,13 @@ static uint64_t get_nanotime()
 
 static uint64_t get_child_ip(pid_t childPid)
 {
+#ifndef _ARM
   user_regs_struct regs = {};
 
   long ptraceRet = ptrace(PTRACE_GETREGS, childPid, NULL, &regs);
   if(ptraceRet == 0)
     return uint64_t(regs.INST_PTR_REG);
+#endif
 
   return 0;
 }
@@ -461,7 +463,7 @@ bool StopChildAtMain(pid_t childPid)
     RDCLOG("Process %u hit entry point", childPid);
 
   // we're now at main! now just need to clean up after ourselves
-
+#ifndef _ARM
   user_regs_struct regs = {};
 
   ptraceRet = ptrace(PTRACE_GETREGS, childPid, NULL, &regs);
@@ -475,6 +477,7 @@ bool StopChildAtMain(pid_t childPid)
   regs.INST_PTR_REG--;
   ptraceRet = ptrace(PTRACE_SETREGS, childPid, NULL, &regs);
   RDCASSERTEQUAL(ptraceRet, 0);
+#endif
 
   // restore the function
   ptraceRet = ptrace(PTRACE_POKETEXT, childPid, entry, origEntryWord);
diff --git a/renderdoc/replay/replay_driver.cpp b/renderdoc/replay/replay_driver.cpp
index a704726..32ce162 100644
--- a/renderdoc/replay/replay_driver.cpp
+++ b/renderdoc/replay/replay_driver.cpp
@@ -1430,8 +1430,8 @@ bytebuf GetDiscardPattern(DiscardType type, const ResourceFormat &fmt, uint32_t
           fmt.type == ResourceFormatType::BC5 || fmt.type == ResourceFormatType::BC6 ||
           fmt.type == ResourceFormatType::BC7)
   {
-#if ENABLED(RDOC_ANDROID)
-    RDCERR("Format %s not supported on android", fmt.Name().c_str());
+#if ENABLED(RDOC_ANDROID) || defined(_ARM)
+    RDCERR("Format %s not supported", fmt.Name().c_str());
 #else
     const uint16_t whalf = ConvertToHalf(1000.0f);
 
-- 
2.7.4

